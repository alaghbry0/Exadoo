import logging
import json
import aiohttp
from aiogram import Bot, Dispatcher, types
from aiogram.utils.web_app import check_webapp_signature
from database.db_queries import record_payment
from quart import current_app

# âœ… ØªØ­Ø³ÙŠÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")

async def handle_pre_checkout(pre_checkout_query: types.PreCheckoutQuery):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙØ¹"""
    try:
        payload = json.loads(pre_checkout_query.invoice_payload)

        if not payload.get("planId") or not payload.get("userId"):
            logging.error(f"âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹ ØºÙŠØ± ØµØ­ÙŠØ­Ø©: {payload}")
            await pre_checkout_query.answer(ok=False, error_message="Invalid payload")
            return

        logging.info(f"âœ… ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù…Ø³ØªØ®Ø¯Ù… {payload['userId']} Ø¨Ù‚ÙŠÙ…Ø© {pre_checkout_query.total_amount}")
        await pre_checkout_query.answer(ok=True)

    except Exception as e:
        logging.error(f"âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø©: {e}")
        await pre_checkout_query.answer(ok=False, error_message="Internal error")


async def handle_successful_payment(message: types.Message):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù†Ø§Ø¬Ø­"""
    try:
        payment = message.successful_payment
        payload = json.loads(payment.invoice_payload)
        telegram_id = payload["userId"]
        plan_id = payload["planId"]
        payment_id = payment.telegram_payment_charge_id
        amount = payment.total_amount // 100  # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Ø¬ÙˆÙ… Ø¥Ù„Ù‰ Ø¯ÙˆÙ„Ø§Ø±

        logging.info(f"âœ… Ø¯ÙØ¹ Ù†Ø§Ø¬Ø­ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {telegram_id}, plan_id: {plan_id}, amount: {amount}")

        db_pool = current_app.db_pool if hasattr(current_app, "db_pool") else None
        if not db_pool:
            logging.error("âŒ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø©!")
            return await message.answer("âš ï¸ Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.")

        # ğŸ”¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¯ÙØ¹ Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡ Ù…Ø³Ø¨Ù‚Ù‹Ø§
        async with db_pool.acquire() as conn:
            existing_payment = await conn.fetchrow(
                "SELECT * FROM payments WHERE payment_id = $1", payment_id
            )
            if existing_payment:
                logging.warning(f"âš ï¸ Ø§Ù„Ø¯ÙØ¹ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§: {payment_id}")
                return await message.answer("âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¯ÙØ¹ØªÙƒ Ø¨Ø§Ù„ÙØ¹Ù„!")

            # ğŸ”¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await record_payment(conn, user_id=telegram_id, payment_id=payment_id, amount=amount, plan_id=plan_id)

        # ğŸ”¹ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ù„Ù‰ API Next.js Ù„ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        for attempt in range(3):  # ğŸ” Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ØªÙ‰ 3 Ù…Ø±Ø§Øª ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
            async with aiohttp.ClientSession() as session:
                try:
                    async with session.post(
                        "https://yourdomain.com/api/subscribe",
                        json={"telegram_id": telegram_id, "subscription_type_id": plan_id, "payment_id": payment_id}
                    ) as resp:
                        if resp.status == 200:
                            logging.info(f"âœ… ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {telegram_id}")
                            return await message.answer("ğŸ‰ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø¨Ù†Ø¬Ø§Ø­!")
                        else:
                            logging.error(f"âŒ ÙØ´Ù„ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© {attempt+1}: {await resp.text()}")

                except Exception as e:
                    logging.error(f"âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ API Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© {attempt+1}: {e}")

        await message.answer("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù….")

    except Exception as e:
        logging.error(f"âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹: {e}")
        await message.answer("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.")


def setup_payment_handlers(dp: Dispatcher):
    """ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¯ÙØ¹ ÙÙŠ Aiogram"""
    dp.pre_checkout_query.register(handle_pre_checkout)
    dp.message.register(handle_successful_payment, content_types=types.ContentType.SUCCESSFUL_PAYMENT)
