import logging
import os
import asyncio
from quart import Blueprint, current_app
from aiogram import Bot, Dispatcher
from aiogram.types import Message, InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
from aiogram.exceptions import TelegramAPIError
from aiogram.filters import Command
from dotenv import load_dotenv

# ØªØ­Ù…ÙŠÙ„ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
load_dotenv()

# Ø¥Ø¹Ø¯Ø§Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† .env
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
WEB_APP_URL = os.getenv("WEB_APP_URL")

# Ø¥Ù†Ø´Ø§Ø¡ Blueprint Ù„Ù„Ø¨ÙˆØª Ø¯Ø§Ø®Ù„ Quart
telegram_bot = Blueprint("telegram_bot", __name__)

# Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† `aiogram` Dispatcher
bot = Bot(token=TELEGRAM_BOT_TOKEN)
dispatcher = Dispatcher()


# Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
async def handle_errors(user_id: int, error_message: str):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†."""
    logging.error(f"âŒ Ø®Ø·Ø£ Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}: {error_message}")


# ÙˆØ¸ÙŠÙØ© /start
@dispatcher.message(Command("start"))
async def start_command(message: Message):
    """Ø¥Ø±Ø³Ø§Ù„ Ø²Ø± ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ØµØºØ± Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… /start."""
    user_id = message.from_user.id
    username = message.from_user.username or "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"

    # Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ØµØºØ±
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ”¹ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ØµØºØ±", web_app=WebAppInfo(url=WEB_APP_URL))]
    ])

    # ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    logging.info(f"âœ… /start Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_id}, Username: {username}")

    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ Ø§Ù„Ø²Ø±
    await message.answer(
        text="Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ! Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ØµØºØ± ğŸ‘‡",
        reply_markup=keyboard
    )


# Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø¨Ø± Ø§Ù„Ø¨ÙˆØª
async def send_message_to_user(user_id: int, message_text: str):
    """Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø¨Ø± Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¨ÙˆØª."""
    if not message_text:
        logging.warning(f"âš ï¸ Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id} Ù„Ø£Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙØ§Ø±Øº.")
        return

    try:
        await bot.send_message(chat_id=user_id, text=message_text)
        logging.info(f"ğŸ“© ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}: {message_text}")

    except TelegramAPIError as e:
        if "chat not found" in str(e).lower():
            await handle_errors(user_id, "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ø¨ÙˆØª Ø£Ùˆ Ù‚Ø§Ù… Ø¨Ø­Ø¸Ø±Ù‡.")
        else:
            await handle_errors(user_id, f"Telegram API Error: {e}")
    except Exception as e:
        await handle_errors(user_id, f"Unexpected error: {e}")


# ØªØ´ØºÙŠÙ„ `aiogram` Ø¯Ø§Ø®Ù„ `Quart`
async def init_bot():
    """Ø±Ø¨Ø· Ø¨ÙˆØª `aiogram` Ù…Ø¹ `Quart` Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚."""
    logging.info("âœ… Telegram Bot Ready!")


# ØªØ´ØºÙŠÙ„ `aiogram` ÙÙŠ Ø³ÙŠØ±ÙØ± `Quart`
async def start_telegram_bot():
    """ØªØ´ØºÙŠÙ„ `aiogram` Dispatcher ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©."""
    loop = asyncio.get_event_loop()
    loop.create_task(dispatcher.start_polling(bot))
